# Reviewer Service

## Запуск проекта

### 1. Клонируйте репозиторий

```sh
git clone https://github.com/wrzdx/reviewer-service.git
cd reviewer-service
```

### 2. Создайте файл окружения

В репозитории есть готовый шаблон:

```sh
cp template.env .env
```

Файл содержит необходимые переменные для локального запуска.

### 3. Установите зависимости Go

```sh
go mod tidy
```

### 4. Запуск сервисов через Docker Compose

```sh
make docker-up # если нет make то вручную запускать команды в Makefile
```

После старта сервис будет доступен на:

```
http://localhost:8080
```

### 5. Запуск тестов

Интеграционные и e2e тесты можно выполнить:

```sh
make test
```

---

## Структура Makefile

Makefile содержит стандартные команды:

* `make build` — сборка бинаря `reviewer-service`
* `make run` — запуск без Docker
* `make docker-up` — запуск с Docker
* `make docker-down` — остановить Docker
* `make test` — запуск тестов
* `make test-load` — запуск стресс теста 
* `make lint` — запуск линтера
* `make lint-fix` — запуск линтера с исправлением

---

## Дополнительные функции

### Эндпоинт статистики

Был добавлен новый эндпоинт для получения статистики по количеству назначений Pull Request'ов для каждого пользователя.

**URL**: `GET http://localhost:8080/stats/assignments`

**Пример ответа**:
```json

[
  {
    "user_id": "u4",
    "username": "Zoro",
    "assigned_pr_count": 1
  },
  {
    "user_id": "u3",
    "username": "Luffy",
    "assigned_pr_count": 1
  }
]
```
---

## Результаты нагрузочного тестирования

Для оценки производительности сервиса использовался инструмент `k6`.

**Сценарий тестирования:** Тестирование эндпоинта статистики `/stats/assignments` при нагрузке до **500 виртуальных пользователей** (VUs) в течение **2 минут**.

**Установленные пороги качества (SLA):**
*   95% запросов должны выполняться быстрее 50 мс (`p(95) < 50ms`).
*   Доля неуспешных запросов должна быть менее 1% (`rate < 0.01%`).

**Ключевые показатели:**

| Показатель | Значение | Статус | Описание |
|------------|-----------|--------|-----------|
| **P95 Latency** | 3.05ms | ✔ PASS | 95% запросов выполнены менее чем за 3.05 миллисекунды |
| **Regs/s** | ~3680 | - | Приложение обработало около 3680 запросов в секунду (среднее значение) |
| **Success Rate** | 100% | ✔ PASS | Все запросы завершились успешно (HTTP 200 OK) |
| **Avg Duration** | 1.38ms | - | Среднее время выполнения запроса |


## Проблемы и решения: 

### Проблема: инициализация схемы базы данных

При развёртывании сервиса Postgres поднимался с пустой базой данных. Это приводило к ошибкам на этапе запуска приложения, поскольку необходимые таблицы отсутствовали. Ручное выполнение SQL-скриптов нарушало повторяемость и усложняло локальное окружение.

### Решение

Для автоматической инициализации базы данных был использован стандартный механизм миграций, доступный в официальном образе `postgres`. В `docker-compose.yml` SQL-файл со схемой был смонтирован в директорию `/docker-entrypoint-initdb.d/`:

```yaml
db:
  image: postgres:15
  restart: always
  env_file:
    - .env
  ports:
    - "5432:5432"
  volumes:
    - db-data:/var/lib/postgresql/data
    - ./app/db/migrations.sql:/docker-entrypoint-initdb.d/migrations.sql
```

При первом запуске контейнера `postgres` автоматически выполняет скрипт `migrations.sql`, создавая все необходимые таблицы и объекты. Это обеспечивает предсказуемое состояние базы данных без дополнительного вмешательства и гарантирует одинаковое поведение окружения у всех участников проекта.

